<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda | Grupo de Jovens</title>

  <meta name="description" content="Agenda oficial do Grupo de Jovens" />
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <div class="bg"></div>

  <header class="container header">
    <div class="brand">
      <div class="logo">‚ú¶</div>
      <div class="brand-text">
        <h1>Agenda do Grupo de Jovens</h1>
        <p id="subtitle">Encontros organizados por m√™s</p>
      </div>
    </div>

    <div class="controls">
      <input
        id="searchInput"
        class="search"
        type="search"
        placeholder="Buscar por t√≠tulo, local ou tipo..."
      />

      <button id="togglePastBtn" class="btn">
        Mostrar passados
      </button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="card-head">
        <div>
          <h2>Agenda</h2>
          <p id="updatedAt" class="muted">Carregando‚Ä¶</p>
        </div>
        <span id="countBadge" class="badge">‚Äî</span>
      </div>

      <p id="status" class="status muted">Carregando agenda‚Ä¶</p>

      <div id="months" class="months"></div>

      <p class="footer-note muted">
        Dica: edite apenas o arquivo <code>events.json</code> para atualizar a agenda.
      </p>
    </section>
  </main>

  <footer class="container footer muted">
    ¬© <span id="year"></span> ‚Ä¢ Grupo de Jovens
  </footer>

  <script>
    const monthsEl = document.getElementById("months");
    const statusEl = document.getElementById("status");
    const searchInput = document.getElementById("searchInput");
    const togglePastBtn = document.getElementById("togglePastBtn");
    const countBadge = document.getElementById("countBadge");
    const updatedAtEl = document.getElementById("updatedAt");
    const subtitleEl = document.getElementById("subtitle");

    document.getElementById("year").textContent = new Date().getFullYear();

    let allEvents = [];
    let showPast = false;

    const MONTHS = [
      "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
    ];

    const WEEKDAYS = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];

    function parseDateTime(value) {
      const parts = value.split("T");
      const date = parts[0].split("-");
      const time = parts[1].split(":");

      return new Date(
        Number(date[0]),
        Number(date[1]) - 1,
        Number(date[2]),
        Number(time[0]),
        Number(time[1])
      );
    }

    function normalize(text) {
      return (text || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    function isPast(date) {
      return date.getTime() < Date.now();
    }

    function buildGoogleCalendarLink(event, start) {
      const duration = event.durationMinutes || 90;
      const end = new Date(start.getTime() + duration * 60000);

      function fmt(d) {
        return (
          d.getFullYear() +
          String(d.getMonth() + 1).padStart(2, "0") +
          String(d.getDate()).padStart(2, "0") +
          "T" +
          String(d.getHours()).padStart(2, "0") +
          String(d.getMinutes()).padStart(2, "0") +
          "00"
        );
      }

      const params = new URLSearchParams({
        action: "TEMPLATE",
        text: event.title,
        dates: fmt(start) + "/" + fmt(end),
        details: event.description || "",
        location: event.location || ""
      });

      return "https://calendar.google.com/calendar/render?" + params.toString();
    }

    function groupByMonth(events) {
      const map = {};

      events.forEach(function (ev) {
        const key = ev.date.getFullYear() + "-" + ev.date.getMonth();
        if (!map[key]) map[key] = [];
        map[key].push(ev);
      });

      return map;
    }

    function render(events) {
      monthsEl.innerHTML = "";
      countBadge.textContent = events.length;

      if (events.length === 0) {
        statusEl.textContent = "Nenhum evento encontrado.";
        return;
      }

      statusEl.textContent = "";

      const grouped = groupByMonth(events);

      Object.keys(grouped)
        .sort()
        .forEach(function (key) {
          const monthEvents = grouped[key];
          const refDate = monthEvents[0].date;

          const monthCard = document.createElement("section");
          monthCard.className = "month-card";

          monthCard.innerHTML = `
            <div class="month-head">
              <span class="month-title">
                ${MONTHS[refDate.getMonth()]} ${refDate.getFullYear()}
              </span>
              <span class="month-count">
                ${monthEvents.length} evento(s)
              </span>
            </div>
            <div class="month-events"></div>
          `;

          const list = monthCard.querySelector(".month-events");

          monthEvents.forEach(function (ev) {
            const day = String(ev.date.getDate()).padStart(2, "0");
            const weekday = WEEKDAYS[ev.date.getDay()];
            const time =
              String(ev.date.getHours()).padStart(2, "0") +
              ":" +
              String(ev.date.getMinutes()).padStart(2, "0");

            const eventEl = document.createElement("article");
            eventEl.className = "event-row" + (isPast(ev.date) ? " is-past" : "");

            eventEl.innerHTML = `
              <div class="event-date">
                <div class="event-day">${day}</div>
                <div class="event-weekday">${weekday}</div>
              </div>

              <div class="event-main">
                <div class="event-top">
                  <span class="pill">${ev.type}</span>
                  <h3 class="event-title">${ev.title}</h3>
                </div>

                <div class="event-meta">
                  ‚è∞ ${time}
                  ${ev.location ? " ‚Ä¢ üìç " + ev.location : ""}
                </div>

                ${ev.description ? `<p class="event-desc">${ev.description}</p>` : ""}
              </div>

              <div class="event-side">
                <div class="event-thumb">
                  ${
                    ev.image
                      ? `<img src="${ev.image}" alt="Arte do evento" />`
                      : `<span>SEM<br>ARTE</span>`
                  }
                </div>

                <a
                  class="btn"
                  href="${buildGoogleCalendarLink(ev, ev.date)}"
                  target="_blank"
                >
                  Google Agenda
                </a>
              </div>
            `;

            list.appendChild(eventEl);
          });

          monthsEl.appendChild(monthCard);
        });

      subtitleEl.textContent = showPast
        ? "Incluindo eventos passados"
        : "Somente pr√≥ximos eventos";
    }

    function applyFilters() {
      const query = normalize(searchInput.value);

      let filtered = allEvents.filter(function (ev) {
        if (!showPast && isPast(ev.date)) return false;

        if (!query) return true;

        const text = normalize(
          ev.title + " " + ev.type + " " + (ev.location || "") + " " + (ev.description || "")
        );

        return text.includes(query);
      });

      render(filtered);
    }

    togglePastBtn.addEventListener("click", function () {
      showPast = !showPast;
      togglePastBtn.textContent = showPast ? "Ocultar passados" : "Mostrar passados";
      applyFilters();
    });

    searchInput.addEventListener("input", applyFilters);

    fetch("./events.json", { cache: "no-store" })
      .then(function (res) {
        return res.json();
      })
      .then(function (data) {
        updatedAtEl.textContent = data.updatedAt
          ? "Atualizado em " + data.updatedAt
          : "";

        allEvents = data.events.map(function (ev) {
          ev.date = parseDateTime(ev.datetime);
          return ev;
        });

        applyFilters();
      })
      .catch(function () {
        statusEl.textContent = "Erro ao carregar events.json";
      });
  </script>
</body>
</html>
