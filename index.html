<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agenda | Grupo de Jovens</title>
  <meta name="description" content="Agenda oficial do Grupo de Jovens" />
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <div class="bg"></div>

  <header class="container header">
    <div class="brand">
      <div class="logo" aria-hidden="true">‚ú¶</div>
      <div class="brand-text">
        <h1>Agenda do Grupo de Jovens</h1>
        <p id="subtitle">Pr√≥ximos encontros e eventos</p>
      </div>
    </div>

    <div class="controls">
      <label class="search">
        <span class="sr-only">Buscar</span>
        <input id="searchInput" type="search" placeholder="Buscar por t√≠tulo, local..." />
      </label>

      <button id="togglePastBtn" class="btn" type="button">
        Mostrar passados
      </button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="card-head">
        <h2>Pr√≥ximos eventos</h2>
        <div class="meta">
          <span id="countBadge" class="badge">‚Äî</span>
          <span id="updatedAt" class="muted">Carregando‚Ä¶</span>
        </div>
      </div>

      <div id="status" class="status muted">Carregando agenda‚Ä¶</div>

      <div id="events" class="events" aria-live="polite"></div>

      <div class="footer-note muted">
        Dica: para editar a agenda, altere apenas o arquivo <code>events.json</code>.
      </div>
    </section>
  </main>

  <footer class="container footer muted">
    <span>¬© <span id="year"></span> ‚Ä¢ Grupo de Jovens</span>
    <span class="dot">‚Ä¢</span>
    <span>Feito para ser simples, bonito e f√°cil de manter</span>
  </footer>

  <script>
    const $ = (sel) => document.querySelector(sel);

    const eventsEl = $("#events");
    const statusEl = $("#status");
    const searchInput = $("#searchInput");
    const togglePastBtn = $("#togglePastBtn");
    const countBadge = $("#countBadge");
    const updatedAt = $("#updatedAt");
    const subtitle = $("#subtitle");

    $("#year").textContent = new Date().getFullYear();

    let allEvents = [];
    let showPast = false;

    function parseLocalDateTime(isoLocal) {
      // Espera "YYYY-MM-DDTHH:mm" (sem timezone)
      // Interpreta no fuso local do navegador (ex.: Brasil)
      const [datePart, timePart = "00:00"] = isoLocal.split("T");
      const [y, m, d] = datePart.split("-").map(Number);
      const [hh, mm] = timePart.split(":").map(Number);
      return new Date(y, m - 1, d, hh, mm, 0, 0);
    }

    function formatDateTime(dt) {
      const date = dt.toLocaleDateString("pt-BR", { weekday: "short", day: "2-digit", month: "short", year: "numeric" });
      const time = dt.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
      return { date, time };
    }

    function isPast(dt) {
      return dt.getTime() < Date.now();
    }

    function normalize(str) {
      return (str || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function buildGoogleCalendarLink(ev, dtStart) {
      // Evento simples: 90 min padr√£o (pode trocar no JSON se quiser)
      const durationMinutes = ev.durationMinutes ?? 90;
      const dtEnd = new Date(dtStart.getTime() + durationMinutes * 60000);

      const pad = (n) => String(n).padStart(2, "0");
      const toGCal = (d) =>
        `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;

      const params = new URLSearchParams({
        action: "TEMPLATE",
        text: ev.title || "Evento",
        dates: `${toGCal(dtStart)}/${toGCal(dtEnd)}`,
        details: ev.description || "",
        location: ev.location || ""
      });

      return `https://calendar.google.com/calendar/render?${params.toString()}`;
    }

    function render(events) {
      eventsEl.innerHTML = "";

      if (!events.length) {
        statusEl.textContent = "Nenhum evento encontrado.";
        statusEl.classList.remove("hidden");
        countBadge.textContent = "0";
        subtitle.textContent = showPast ? "Eventos (incluindo passados)" : "Pr√≥ximos encontros e eventos";
        return;
      }

      statusEl.classList.add("hidden");
      countBadge.textContent = String(events.length);
      subtitle.textContent = showPast ? "Eventos (incluindo passados)" : "Pr√≥ximos encontros e eventos";

      for (const ev of events) {
        const dt = parseLocalDateTime(ev.datetime);
        const { date, time } = formatDateTime(dt);
        const past = isPast(dt);

        const tag = (ev.type || "Encontro").trim();
        const gcal = buildGoogleCalendarLink(ev, dt);

        const el = document.createElement("article");
        el.className = "event" + (past ? " is-past" : "");

        el.innerHTML = `
          <div class="event-left">
            <div class="pill">${tag}</div>
            <h3 class="event-title">${ev.title || "Sem t√≠tulo"}</h3>
            <div class="event-sub">
              <span class="kv">
                <span class="k">üìÖ</span>
                <span class="v">${date}</span>
              </span>
              <span class="kv">
                <span class="k">‚è∞</span>
                <span class="v">${time}</span>
              </span>
              ${ev.location ? `
              <span class="kv">
                <span class="k">üìç</span>
                <span class="v">${ev.location}</span>
              </span>` : ""}
            </div>

            ${ev.description ? `<p class="event-desc">${ev.description}</p>` : ""}
          </div>

          <div class="event-actions">
            ${ev.link ? `<a class="btn btn-ghost" href="${ev.link}" target="_blank" rel="noopener">Detalhes</a>` : ""}
            <a class="btn" href="${gcal}" target="_blank" rel="noopener">Adicionar ao Google Agenda</a>
          </div>
        `;

        eventsEl.appendChild(el);
      }
    }

    function applyFilters() {
      const q = normalize(searchInput.value);
      const now = Date.now();

      let list = allEvents
        .map(ev => ({ ...ev, _dt: parseLocalDateTime(ev.datetime) }))
        .filter(ev => showPast ? true : ev._dt.getTime() >= now - 60000) // toler√¢ncia 1 min
        .sort((a, b) => a._dt - b._dt);

      if (q) {
        list = list.filter(ev => {
          const hay = normalize([ev.title, ev.location, ev.type, ev.description].filter(Boolean).join(" "));
          return hay.includes(q);
        });
      }

      render(list);
    }

    async function load() {
      try {
        statusEl.textContent = "Carregando agenda‚Ä¶";
        statusEl.classList.remove("hidden");

        const res = await fetch("./events.json", { cache: "no-store" });
        if (!res.ok) throw new Error("N√£o foi poss√≠vel carregar events.json");

        const data = await res.json();
        allEvents = Array.isArray(data.events) ? data.events : [];

        updatedAt.textContent = data.updatedAt
          ? `Atualizado em ${data.updatedAt}`
          : "Atualiza√ß√£o n√£o informada";

        applyFilters();
      } catch (err) {
        statusEl.textContent = "Erro ao carregar a agenda. Verifique o arquivo events.json.";
        statusEl.classList.remove("hidden");
        console.error(err);
      }
    }

    togglePastBtn.addEventListener("click", () => {
      showPast = !showPast;
      togglePastBtn.textContent = showPast ? "Ocultar passados" : "Mostrar passados";
      applyFilters();
    });

    searchInput.addEventListener("input", applyFilters);

    load();
  </script>
</body>
</html>
